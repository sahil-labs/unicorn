// Prisma schema for Micro-Creator Affiliate Marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  BRAND
  CREATOR
}

enum SubscriptionTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransactionType {
  SALE
  COMMISSION
  PAYOUT
  REFUND
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  role          UserRole  @default(CREATOR)
  
  // Auth relations
  accounts      Account[]
  sessions      Session[]
  
  // Profile relations
  brandProfile   BrandProfile?
  creatorProfile CreatorProfile?
  
  // Activity
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  lastLoginAt DateTime?

  @@index([email])
  @@index([role])
}

model BrandProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Business info
  businessName     String
  businessType     String?
  website          String?
  description      String?   @db.Text
  logo             String?
  
  // Subscription
  subscriptionTier SubscriptionTier @default(FREE)
  subscriptionId   String?          @unique
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  
  // Razorpay
  razorpayCustomerId String? @unique
  
  // Relationships
  products     Product[]
  coupons      Coupon[]
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([subscriptionTier])
}

model CreatorProfile {
  id       String @id @default(uuid())
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile info
  bio          String?   @db.Text
  instagram    String?
  youtube      String?
  twitter      String?
  website      String?
  niche        String[]
  
  // Stats
  totalClicks      Int @default(0)
  totalConversions Int @default(0)
  totalEarnings    Decimal @default(0) @db.Decimal(10, 2)
  
  // KYC & Payout
  kycVerified      Boolean @default(false)
  kycDocuments     Json?
  razorpayContactId String? @unique
  razorpayFundAccountId String? @unique
  bankAccountName  String?
  bankAccountNumber String?
  bankIfsc         String?
  upiId            String?
  panNumber        String?
  
  // Relationships
  affiliateLinks AffiliateLink[]
  payouts        Payout[]
  transactions   Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model Product {
  id          String   @id @default(uuid())
  brandId     String
  brand       BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  // Product details
  name        String
  description String   @db.Text
  slug        String   @unique
  images      String[]
  price       Decimal  @db.Decimal(10, 2)
  salePrice   Decimal? @db.Decimal(10, 2)
  currency    String   @default("INR")
  
  // Product URLs
  productUrl  String
  
  // Commission
  commissionRate    Decimal @db.Decimal(5, 2) // percentage
  commissionAmount  Decimal? @db.Decimal(10, 2) // fixed amount alternative
  
  // Settings
  isActive    Boolean @default(true)
  featured    Boolean @default(false)
  
  // Metadata
  category    String?
  tags        String[]
  
  // Stats
  totalClicks      Int @default(0)
  totalConversions Int @default(0)
  totalRevenue     Decimal @default(0) @db.Decimal(10, 2)
  
  // Relationships
  affiliateLinks AffiliateLink[]
  coupons        Coupon[]
  transactions   Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  @@index([brandId])
  @@index([slug])
  @@index([isActive])
  @@index([category])
}

model AffiliateLink {
  id         String   @id @default(uuid())
  creatorId  String
  creator    CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Link details
  slug       String   @unique // for /r/[slug]
  fullUrl    String   // generated affiliate URL
  
  // UTM parameters
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  
  // Stats
  clicks       Int @default(0)
  conversions  Int @default(0)
  revenue      Decimal @default(0) @db.Decimal(10, 2)
  commission   Decimal @default(0) @db.Decimal(10, 2)
  
  // Settings
  isActive     Boolean @default(true)
  
  // Relationships
  clicks_log   Click[]
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([creatorId, productId])
  @@index([slug])
  @@index([creatorId])
  @@index([productId])
}

model Coupon {
  id          String   @id @default(uuid())
  brandId     String
  brand       BrandProfile @relation(fields: [brandId], references: [id], onDelete: Cascade)
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  // Coupon details
  code        String   @unique
  description String?
  discountType String  // PERCENTAGE or FIXED
  discountValue Decimal @db.Decimal(10, 2)
  
  // Commission for this coupon
  commissionRate Decimal @db.Decimal(5, 2)
  
  // Validity
  startDate   DateTime
  endDate     DateTime?
  maxUses     Int?
  currentUses Int @default(0)
  
  // Settings
  isActive    Boolean @default(true)
  
  // Relationships
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([code])
  @@index([brandId])
  @@index([productId])
}

model Click {
  id           String   @id @default(uuid())
  linkId       String
  link         AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  // Tracking data
  ipAddress    String?
  userAgent    String?
  referer      String?
  country      String?
  city         String?
  
  // Cookie/Session
  clickId      String   @unique // stored in cookie
  
  // Attribution window
  expiresAt    DateTime // clickedAt + 7 days
  converted    Boolean  @default(false)
  
  clickedAt    DateTime @default(now())
  
  @@index([linkId])
  @@index([clickId])
  @@index([expiresAt])
}

model Transaction {
  id            String   @id @default(uuid())
  type          TransactionType
  
  // Relationships
  brandId       String?
  brand         BrandProfile? @relation(fields: [brandId], references: [id], onDelete: SetNull)
  creatorId     String?
  creator       CreatorProfile? @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  productId     String?
  product       Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  linkId        String?
  link          AffiliateLink? @relation(fields: [linkId], references: [id], onDelete: SetNull)
  couponId      String?
  coupon        Coupon? @relation(fields: [couponId], references: [id], onDelete: SetNull)
  
  // Transaction details
  amount        Decimal @db.Decimal(10, 2)
  commission    Decimal @default(0) @db.Decimal(10, 2)
  currency      String  @default("INR")
  
  // Order details
  orderId       String?
  orderDetails  Json?
  
  // Attribution
  attributionSource String? // LINK or COUPON
  clickId       String?
  
  // Status
  status        String  @default("PENDING") // PENDING, COMPLETED, REFUNDED
  
  // Metadata
  metadata      Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([brandId])
  @@index([creatorId])
  @@index([productId])
  @@index([linkId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Payout {
  id           String   @id @default(uuid())
  creatorId    String
  creator      CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  // Payout details
  amount       Decimal @db.Decimal(10, 2)
  currency     String  @default("INR")
  method       String  // BANK_TRANSFER, UPI
  
  // Razorpay
  razorpayPayoutId String? @unique
  razorpayOrderId  String? @unique
  
  // Status
  status       PayoutStatus @default(PENDING)
  statusMessage String?
  
  // Metadata
  transactionIds String[] // IDs of transactions included in this payout
  metadata     Json?
  
  // Timestamps
  requestedAt  DateTime @default(now())
  processedAt  DateTime?
  completedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([creatorId])
  @@index([status])
  @@index([requestedAt])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  changes   Json?
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

model FeatureFlag {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  enabled     Boolean  @default(false)
  config      Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([name])
}

